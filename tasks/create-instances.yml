---
- name: create {{ type }} instances
  command: tor-instance-create {{ item.name }}
  args:
    creates: /etc/tor/instances/{{ item.name }}/torrc
  with_items: "{{ instances }}"

- name: copy {{ type }} offline keys
  copy:
    src: "{{ tor_offline_keys }}/{{ inventory_hostname }}/{{ item[0].name }}/keys/{{ item[1] }}"
    dest: /var/lib/tor-instances/{{ item[0].name }}/keys/
    mode: 0600
    owner: _tor-{{ item[0].name }}
    group: _tor-{{ item[0].name }}
  with_nested:
    - "{{ instances }}"
    - [ed25519_master_id_public_key, ed25519_signing_cert, ed25519_signing_secret_key]
  notify: reload Tor
  tags: copy-offline-keys

- name: template {{ type }} configurations
  template:
    src: "{{ type }}.j2"
    dest: /etc/tor/instances/{{ item.name }}/torrc
    backup: yes
  with_items: "{{ instances }}"
  notify: reload Tor

- name: enable {{ type }} services
  service:
    name: "tor@{{ item.name }}"
    enabled: yes
    state: started
  with_items: "{{ instances }}"
